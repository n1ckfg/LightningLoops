class LatkPoint{constructor(t,e,r,s){void 0===e&&(e=1),void 0===r&&(r=1),void 0===s&&(s=[0,0,0,0]),this.co=t=void 0===t?[0,0,0]:t,this.pressure=e,this.strength=r,this.vertex_color=s}}class LatkStroke{constructor(t,e,r){void 0===e&&(e=[0,0,0,1]),void 0===r&&(r=[0,0,0,0]),this.points=t=void 0===t?[]:t,this.color=e,this.fill_color=r,this.timestamp=(new Date).getTime()}setCoords(t){this.points=[];for(var e of t)this.points.push(new LatkPoint(e))}getCoords(){let t=[];for(var e of this.points)t.push(e.co);return t}getPressures(){let t=[];for(var e of this.points)t.push(e.pressure);return t}getStrengths(){let t=[];for(var e of this.points)t.push(e.strength);return t}}class LatkFrame{constructor(t){void 0===t&&(t=0),this.strokes=[],this.frame_number=t,this.parent_location=[0,0,0],console.log("New frame: "+t)}getLastStroke(){return this.strokes[this.strokes.length-1]}}class LatkLayer{constructor(t){void 0===t&&(t="layer"),this.frames=[],this.name=t,this.parent=void 0,this.counter=0,this.loopCounter=0,this.previousFrame=0,console.log("New layer: "+this.name)}getInfo(t){return this.name.split(".")[0]}getPreviousFrame(){return this.frames[this.previousFrame]}getLastFrame(){return this.frames[this.frames.length-1]}getCurrentFrame(){return this.frames[this.counter]}}class Latk{constructor(t,e,r){if(this.layers=[],this.frame_rate=12,this.clearExisting=!0,this.yUp=!0,this.useScaleAndOffset=!1,this.globalScale=[100,100,100],this.globalOffset=[0,0,0],!(this.ready=!1)===t){if(this.layers.push(new LatkLayer),this.layers[0].frames.push(new LatkFrame),void 0!==e){let t=new LatkStroke;t.setCoords(e),void 0!==r&&(t.color=r),this.layers[0].frames[0].strokes.push(t)}this.ready=!0}}static read(t){let e=new Latk,r=new XMLHttpRequest;return r.overrideMimeType("application/json"),r.open("GET",t,!0),r.onreadystatechange=function(){4==r.readyState&&"200"==r.status&&(e.layers=Latk.jsonToGp(JSON.parse(r.responseText)),console.log("Latk loaded from json."),e.ready=!0)},r.send(null),e}readJson(t){this.layers=Latk.jsonToGp(t),console.log("Latk loaded from json."),this.ready=!0}readBase64(t){}static jsonToGp(t){let r=[];for(var e of t.grease_pencil)for(var s of e.layers){let e=new LatkLayer(s.name);for(var o of s.frames){let t=new LatkFrame;for(var a of o.strokes){let e=[0,0,0,1];try{var n=a.color[0],l=a.color[1],h=a.color[2];let t=1;try{t=a.color[3]}catch(t){}e=[n,l,h,t]}catch(t){}let r=[0,0,0,0];try{var c=a.fill_color[0],f=a.fill_color[1],p=a.fill_color[2];let t=0;try{t=a.fill_color[3]}catch(t){}r=[c,f,p,t]}catch(t){}let i=[];for(var u of a.points){let t=u.co[0],e,r;r=!1===latk.yUp?(e=u.co[2],u.co[1]):(e=u.co[1],u.co[2]),!0===latk.useScaleAndOffset&&(t=t*globalScale[0]+globalOffset[0],e=e*globalScale[1]+globalOffset[1],r=r*globalScale[2]+globalOffset[2]);let s=1,o=1,a=[0,0,0,1];try{s=u.pressure,!0===isNaN(s)&&(s=1)}catch(t){}try{o=u.strength,!0===isNaN(o)&&(o=1)}catch(t){}try{a=u.vertex_color,!0===isNaN(a)&&(a=[0,0,0,1])}catch(t){}i.push(new LatkPoint([t,e,r],s,o,a))}a=new LatkStroke(i,e,r);t.strokes.push(a)}e.frames.push(t)}r.push(e)}return r}static gpToJson(t){}static download(t,e){let r=document.createElement("a");"string"==typeof r.download?(document.body.appendChild(r),r.download=e,r.href=t,r.click(),document.body.removeChild(r)):location.replace(uri)}static getFileNameNoExt(t){let e="";var r=t.toString().split(".");if(!(1<r.length))return t;for(let t=0;t<r.length-1;t++)0<t&&(e+="."),e+=r[t];return e}static getExtFromFileName(t){t=t.toString().split(".");return t[t.length-1]}static jsonContains(t,e){let r=""+t;return-1<r.indexOf(e)}clean(t){void 0===t&&(t=.01);for(var e of this.layers)for(var r of e.frames)for(var s of r.strokes){coords=[],pressures=[],strengths=[];for(var o of s.points)coords.push(o.co),pressures.push(o.pressure),strengths.push(o.strength);s.setCoords(rdp(coords,t));for(let t=0;t<s.points.length;t++){var a=this.remapInt(t,0,s.points.length,0,pressures.length);s.points[t].pressure=pressures[a],s.points[t].strength=strengths[a]}}}filter(t,e){(void 0===t||t<2)&&(t=2),void 0===e&&(e=.1);for(var r of this.layers)for(var s of r.frames)for(var o of s.strokes)if(o.points.length<t)try{s.strokes.remove(o)}catch(t){}else{totalLength=0;for(let t=1;t<o.points.length;t++)if(p1=o.points[t],p2=o.points[t-1],this.hitDetect3D(p1.co,p2.co,.1))try{o.points.remove(o)}catch(t){}else totalLength+=this.getDistance(p1.co,p2.co);if(totalLength<e)try{s.strokes.remove(o)}catch(t){}else if(o.points.length<t)try{s.strokes.remove(o)}catch(t){}}}normalize(t,e){void 0===t&&(t=0),void 0===e&&(e=1);let r=[],s=[],o=[];for(var a of this.layers)for(var i of a.frames)for(var n of i.strokes)for(var l of n.points){l=l.co;r.push(l[0]),s.push(l[1]),o.push(l[2])}r.sort(),s.sort(),o.sort();let h=[r[0],s[0],o[0]],c=[r[len(r)-1],s[len(s)-1],o[len(o)-1]];h.sort(),c.sort();var f,p=h[0],u=c[2]-p,g=(r[len(r)-1]-r[0])/u,p=(s[len(s)-1]-s[0])/u,u=(o[len(o)-1]-o[0])/u,d=t*g,v=t*p,m=t*u,k=e*g,L=e*p,S=e*u;for(f of this.layers)for(var w of f.frames)for(var C of w.strokes)for(var F of C.points)coord=F.co,x=this.remap(coord[0],r[0],r[len(r)-1],d,k),y=this.remap(coord[1],s[0],s[len(s)-1],v,L),z=this.remap(coord[2],o[0],o[len(o)-1],m,S),F.co=(x,y,z)}smoothStroke(e){var r=e.points;for(let t=1;t<r.length-2;t++){var s=r[t-1].co,o=r[t].co,a=r[t+1].co,i=.05*(s[0]+18*o[0]+a[0]),n=.05*(s[1]+18*o[1]+a[1]),l=.05*(s[2]+18*o[2]+a[2]);e.points[t].co=[i,n,l]}}splitStroke(e){var r=e.points;for(let t=1;t<r.length;t+=2){var s=[r[t].co[0],r[t].co[1],r[t].co[2]],o=[r[t-1].co[0],r[t-1].co[1],r[t-1].co[2]],o=[(s[0]+o[0])/2,(s[1]+o[1])/2,(s[2]+o[2])/2];pressure=(r[t-1].pressure+r[t].pressure)/2,strength=(r[t-1].strength+r[t].strength)/2;o=new LatkPoint(o,pressure,strength);e.points.insert(t,o)}}reduceStroke(e){for(let t=0;t<e.points.length;t+=2)e.points.remove(e.points[t])}refine(e,r,s,t){void 0===e&&(e=2),void 0===r&&(r=10),void 0===s&&(s=0),!0===(t=void 0===t?!0:t)&&this.clean(),r<e&&(r=e);for(var o of this.layers)for(var a of o.frames)for(var i of a.strokes){i.points;for(let t=0;t<e;t++)this.splitStroke(i),this.smoothStroke(i);for(let t=0;t<r-e;t++)this.smoothStroke(i);for(let t=0;t<s;t++)this.reduceStroke(i)}}setStroke(t){var e=this.layers[len(this.layers)-1];let r=e.frames[len(e.frames)-1];r.strokes.push(t)}setPoints(t,e){void 0===e&&(e=1);var r=this.layers[len(this.layers)-1];let s=r.frames[len(r.frames)-1],o=new LatkStroke;o.points=t,o.color=e,s.strokes.push(o)}setCoords(t,e){void 0===e&&(e=1);var r=this.layers[this.layers.length-1];let s=r.frames[r.frames.length-1],o=new LatkStroke;o.setCoords(t),o.color=e,s.strokes.push(o)}getDistance(t,e){return sqrt((t[0]-e[0])**2+(t[1]-e[1])**2+(t[2]-e[2])**2)}hitDetect3D(t,e,r){return void 0===r&&(r=.01),this.getDistance(t,e)<=r}roundVal(t,e){let r="{0:."+str(e)+"f}";return r.format(t)}roundValInt(t){let e="{0:."+str(0)+"f}";return parseInt(e.format(t))}remap(t,e,r,s,o){return s+(t-e)/(r-e)*(o-s)}remapInt(t,e,r,s,o){return parseInt(this.remap(t,e,r,s,o))}getLastLayer(){return this.layers[this.layers.length-1]}getLoopFrame(t){return this.getLongestLayer().loopCounter*(this.getLongestLayer().frames.length-1)}getLongestLayer(){let e=0;for(let t=0;t<this.layers.length;t++)this.layers[t].frames.length>e&&(e=t);return this.layers[i]}}